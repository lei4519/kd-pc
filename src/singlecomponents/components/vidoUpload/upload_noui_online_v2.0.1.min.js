/* eslint-disable */
/*
 * @Author: yinxiaopeng
 * @Date:   2018-03-30 15:50:03
 * @Last Modified by:   yinxiaopeng
 * @Last Modified time: 2018-03-30 15:50:29
 */

function uploadFile(obj) {
  var that = this
  var apis = {
    getSign: '//api-zb.leju.com/mrp-video/upload/video/sign', //123.207.54.92:9112
    getFinishSign: '//api-zb.leju.com/mrp-video/upload/video/callBack'
  }
  var partner = ''
  var fileId = '' //鏂囦欢id
  var fileUrl = '' //鏂囦欢url
  var videoId = '' //瑙嗛id
  var callBackSign = '' //璇锋眰鍥炶皟绛惧悕
  var sign = '' //涓婁紶绛惧悕
  var title = '' //瑙嗛鏍囬
  var description = '' //瑙嗛鎻忚堪
  var coverUrl = '' //灏侀潰鍥剧墖
  var videoFileList = []
  var coverFileList = []
  var retryStartNum = 3
  var retJson = {
    apistatus: 0,
    result: {}
  }

  /**
   * 鍒濆鍖栫粍浠�
   */
  this.init = function() {
    var o = document.createElement('script')
    o.type = 'text/javascript'
    o.src =
      '//cdn-zb.leju.com/js/ugcUploader_v1.0.0.js?t=' +
      Math.random()
        .toString(36)
        .substr(2)
    document.getElementsByTagName('head')[0].appendChild(o)
  }

  /**
   * 璁＄畻绛惧悕
   **/
  this.getSignature = function(liveId) {
    try {
      partner = obj.partner
    } catch (err) {
      partner = ''
      console.log('涓氬姟鏂筰d涓哄繀濉」锛�')
    } finally {
    }
    if (partner == '') {
      console.log('涓氬姟鏂筰d涓嶈兘涓虹┖锛�')
      return
    }
    $.ajax({
      url:
        apis.getSign +
        '?u=' +
        Math.random()
          .toString(36)
          .substr(2),
      data: {
        partner: partner,
        videoId: liveId || ''
      },
      async: false,
      type: 'POST',
      dataType: 'json',
      success: function(res) {
        if (!parseInt(res.code)) {
          console.log(res)
          sign = res.data.sign
          videoId = res.data.videoId
          callBackSign = res.data.callBackSign
        } else {
          retJson.result.errorCode = 400
          retJson.result.errorMsg = res.msg
          obj.fail(retJson)
        }
      }
    })
  }

  /**
   *涓婁紶鏂规硶
   */
  this.upload = function() {
    if (typeof obj !== 'object') {
      console.log('obj蹇呴』涓哄璞℃垨瀵硅薄涓嶈兘涓虹┖')
      return
    }
    var liveId = obj.liveId || ''
    var coverFile = obj.coverFile || ''
    that.getSignature(liveId)
    if (obj.title) {
      title = obj.title || ''
    }
    var resultMsg = lejuUploader.upload({
      videoFile: obj.videoFile,
      videoName: videoId + '_' + obj.videoFile.name,
      coverFile: coverFile,
      signature: sign,
      success: function(result) {
        if (result.type == 'video') {
        }
      },
      error: function(result) {
        retJson.result.errorCode = 400
        retJson.result.errorMsg = result.msg
        obj.fail(retJson)
      },
      progress: function(result) {
        if (result.type == 'video') {
          var prenct = Math.floor(result.curr * 100) + '%'
          obj.process(prenct)
        }
      },
      finish: function(result) {
        fileId = result.fileId
        fileUrl = result.videoUrl
        coverUrl = result.coverUrl || ''
        that.finishSignature()
        retJson.apistatus = 1
        retJson.result.videoUrl = result.videoUrl
        retJson.result.coverUrl = coverUrl
        retJson.result.videoId = videoId
        retJson.result.fileId = fileId
        obj.success(retJson)
      }
    })
  }

  /**
   * 涓婁紶瀹屾垚鍥炶皟鎺ュ彛
   */
  this.finishSignature = function() {
    console.log(videoId)
    console.log(callBackSign)
    $.ajax({
      url: apis.getFinishSign,
      data: {
        partner: partner,
        fileId: fileId,
        videoUrl: fileUrl,
        videoId: videoId,
        title: title,
        callBackSign: callBackSign
      },
      type: 'POST',
      dataType: 'json',
      success: function(res) {
        if (parseInt(res.code)) {
          if (retryStartNum > 0) {
            setTimeout(function() {
              that.finishSignature()
              retryStartNum--
            }, 1e3)
          }
        }
      }
    })
  }
}
var uploadObj
var init = (function() {
  uploadObj = new uploadFile()
  uploadObj.init()
})()
export {
  uploadFile
}
